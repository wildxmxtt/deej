# Define the Arduino device COM port
$arduinoPort = "COM4"
$deejPath = "C:\Users\UserName\Documents\Deej\deej.exe"
$sourceID = "ArduinoDeviceChange5"

Register-WmiEvent -Class win32_DeviceChangeEvent -SourceIdentifier $sourceID
# Define the action to take when the device change is detected
function start-Deej {
    param (
      $device
    )
    $device = Get-WmiObject Win32_SerialPort | Where-Object { $_.DeviceID -eq $arduinoPort }

    #if usb is plugged in 
    if($null -ne $device){
    #if program is not running
        $id = Get-Process -name deej
        if($null -eq $id){
            #start program
            Write-Host "Starting Deej"
            Start-Process $deejPath -WindowStyle Hidden -ErrorAction SilentlyContinue
        }
    #If ubs not plugged in
    #check if program is running
    }else{
        #has to do this as a job as script will fly right by it if not
        $job = Start-Job -ScriptBlock { Get-Process -name deej } -PSVersion 5.1
        while ($job.JobStateInfo.State -ne "Completed") {
            $job | Select-Object -Property JobStateInfo  
        }
    
        $id = Receive-Job -Job $job
        #if usn not plugged in AND program is running, kill deej.exe
        if($null -ne $id){
            #stop program
            Write-Host "Stopping Deej"
            Stop-Process -ID $id.id -ErrorAction SilentlyContinue
        }
    }
    

}

$device = Get-WmiObject Win32_SerialPort | Where-Object { $_.DeviceID -eq $arduinoPort }
start-Deej -device $device

# Continuously monitor for device change events
while ($true) {
    $newEvent = Wait-Event -SourceIdentifier $sourceID
    $newEvent.SourceEventArgs.NewEvent
    $device = Get-WmiObject Win32_SerialPort | Where-Object { $_.DeviceID -eq $arduinoPort }
    start-Deej -device $device
    Remove-Event -SourceIdentifier $sourceID
}
